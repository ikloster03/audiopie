---
sidebar_position: 2
---

# Настройка FFmpeg

AudioPie использует [FFmpeg](https://ffmpeg.org/) для обработки аудио. Это руководство охватывает настройку и устранение неполадок FFmpeg.

## Что такое FFmpeg?

FFmpeg — мощный инструмент с открытым исходным кодом для работы с мультимедийными файлами. AudioPie использует его для:

- Чтения информации о MP3-файлах (FFprobe)
- Конвертации MP3 в AAC
- Объединения аудиотреков
- Встраивания глав и метаданных
- Добавления обложки

## Встроенный FFmpeg

AudioPie включает встроенную версию FFmpeg, которая работает «из коробки»:

- **Настройка не требуется**
- Работает на всех платформах
- Проверен на совместимость

Встроенный FFmpeg используется по умолчанию, когда не указан пользовательский путь.

## Использование системного FFmpeg

Если вы предпочитаете использовать системную установку FFmpeg:

### Linux

```bash
# Проверьте, установлен ли FFmpeg
ffmpeg -version
ffprobe -version

# Установка при необходимости (Ubuntu/Debian)
sudo apt install ffmpeg

# Установка при необходимости (Fedora)
sudo dnf install ffmpeg

# Установка при необходимости (Arch)
sudo pacman -S ffmpeg
```

Типичные пути:
- `/usr/bin/ffmpeg`
- `/usr/bin/ffprobe`

### Windows

1. Скачайте FFmpeg с [ffmpeg.org](https://ffmpeg.org/download.html)
2. Распакуйте в папку (например, `C:\ffmpeg`)
3. Добавьте в PATH или укажите в настройках AudioPie

Типичные пути:
- `C:\ffmpeg\bin\ffmpeg.exe`
- `C:\ffmpeg\bin\ffprobe.exe`

### macOS

```bash
# Установка через Homebrew
brew install ffmpeg

# Проверка установки
which ffmpeg
which ffprobe
```

Типичные пути:
- `/usr/local/bin/ffmpeg`
- `/opt/homebrew/bin/ffmpeg` (Apple Silicon)

## Настройка пользовательского FFmpeg

Чтобы использовать пользовательскую установку FFmpeg:

1. Откройте **Настройки** (значок шестерёнки)
2. Укажите **Путь FFmpeg** к вашему исполняемому файлу `ffmpeg`
3. Укажите **Путь FFprobe** к вашему исполняемому файлу `ffprobe`
4. Закройте Настройки для сохранения

### Проверка конфигурации

После установки пользовательских путей попробуйте добавить трек для проверки:
- Если успешно, FFmpeg работает корректно
- Если ошибки, проверьте пути

## Требования к FFmpeg

AudioPie требует FFmpeg с этими кодеками:

| Кодек | Назначение | Обязательно |
|-------|------------|-------------|
| libmp3lame | Чтение MP3 файлов | ✅ |
| aac | Кодирование AAC аудио | ✅ |
| mov/mp4 | Контейнер M4B | ✅ |

Большинство сборок FFmpeg включают их по умолчанию.

### Проверка поддержки кодеков

```bash
# Проверка поддержки MP3
ffmpeg -codecs | grep mp3

# Проверка поддержки AAC
ffmpeg -codecs | grep aac

# Проверка поддержки M4B/M4A
ffmpeg -formats | grep m4a
```

## Устранение неполадок

### «FFmpeg не найден»

1. Проверьте, правильно ли указаны пути в настройках
2. Убедитесь, что FFmpeg имеет права на выполнение:
   ```bash
   chmod +x /путь/к/ffmpeg
   ```
3. Попробуйте очистить пути для использования встроенного FFmpeg

### «FFprobe не найден»

FFprobe обычно устанавливается вместе с FFmpeg. Если отсутствует:

1. Переустановите FFmpeg полностью
2. Скачайте с официальных источников
3. Убедитесь, что оба файла одной версии

### Ошибка кодирования

```
Ошибка: Кодирование не удалось...
```

Возможные причины:
- Исходный файл повреждён
- Недостаточно места на диске
- FFmpeg не имеет прав на запись
- Несовместимая версия FFmpeg

Решения:
- Попробуйте встроенный FFmpeg (очистите пользовательские пути)
- Перекодируйте исходные файлы другим инструментом
- Проверьте место на диске
- Обновите FFmpeg до последней версии

### Медленное кодирование

Если кодирование очень медленное:

1. Проверьте настройку **Потоки FFmpeg**
2. Убедитесь, что не запущены другие ресурсоёмкие задачи
3. Рассмотрите уменьшение выходного битрейта
4. Проверьте загрузку CPU во время кодирования

### Неправильно определяется длительность

Если длительность треков неправильная:

```bash
# Проверьте файл напрямую
ffprobe -v error -show_entries format=duration \
  -of default=noprint_wrappers=1:nokey=1 \
  "путь/к/файлу.mp3"
```

Если FFprobe сообщает неправильную длительность:
- Исходный файл может иметь проблемы
- Попробуйте перекодировать исходник
- Проверьте проблемы с VBR (Variable Bit Rate)

### Главы не работают

Если главы не появляются в выходном файле:

1. Проверьте, что главы настроены в AudioPie
2. Проверьте, что версия FFmpeg поддерживает Nero chapters:
   ```bash
   ffmpeg -version
   # Должна быть 4.0 или новее
   ```
3. Попробуйте собрать простой тестовый случай

## Совместимость версий FFmpeg

AudioPie протестирован с:
- FFmpeg 4.x
- FFmpeg 5.x
- FFmpeg 6.x

Старые версии (3.x и ниже) могут иметь проблемы.

### Проверка вашей версии

```bash
ffmpeg -version
# Рекомендуется FFmpeg 6.0 или новее
```

## Расширенная настройка

### Пользовательская сборка FFmpeg

Если вам нужна пользовательская сборка FFmpeg:

```bash
# Пример: Сборка с определёнными опциями
./configure --enable-gpl --enable-libmp3lame --enable-libfdk-aac
make -j8
sudo make install
```

### Использование FFmpeg из контейнера

Если запускаете AudioPie с Docker/Flatpak:
- FFmpeg должен быть доступен внутри контейнера
- Используйте встроенный FFmpeg для лучшей совместимости

## Советы по производительности

### Скорость кодирования

| Потоки | Скорость | Нагрузка CPU |
|--------|----------|--------------|
| 1 | Медленно | Низкая |
| 2 | Умеренно | Средняя |
| 4 | Быстро | Высокая |
| 8+ | Очень быстро | Очень высокая |

### Качество vs Скорость

Для более быстрых сборок с тем же качеством:
- Убедитесь, что потоки FFmpeg настроены правильно
- Используйте SSD для места вывода
- Закройте другие приложения во время сборки

### Использование памяти

FFmpeg обычно использует 100-500 МБ RAM во время кодирования. Убедитесь, что у вас достаточно свободной памяти для:
- Процесса FFmpeg
- Приложения AudioPie
- Операционной системы

